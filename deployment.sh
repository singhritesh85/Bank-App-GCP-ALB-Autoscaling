#!/bin/bash
DEXTER=`/opt/packer build template.json | tail -1`;
image_name=`echo $DEXTER | cut -d ":" -f2- | cut -d ":" -f2`;
gcloud compute instance-templates create bankapp-template`date +"%H%d%m%Y"` --description="Instances with Bank Application installed" --provisioning-model="STANDARD" --restart-on-failure --maintenance-policy="MIGRATE" --machine-type=n1-standard-1 --region=us-central1 --create-disk=boot=true,auto-delete=true,type="pd-standard",size=20GB,disk-resource-policy="bankapp-boot-disk-snapshot,image="${image_name//[[:blank:]]/}",image-project=XXXX-XXXXXXX-2XXXX6"  --create-disk=auto-delete=true,type="pd-standard",size=10GB,device-name="sdb",disk-resource-policy="bankapp-extra-disk-snapshot" --labels=environment="dev" --tags="allow-ssh","allow-health-check" --metadata-from-file startup-script="startup-image-template.sh" --network-interface="network=bankapp-vpc,subnet=bankapp-us-central1-public-subnet,network-tier=PREMIUM" --metadata=environment="dev" --project=XXXX-XXXXXXX-2XXXX6 --service-account=bankapp-sa@XXXX-XXXXXXX-2XXXX6.iam.gserviceaccount.com;
gcloud compute instance-groups managed rolling-action start-update bankapp-instance-group --project=XXXX-XXXXXXX-2XXXX6 --version=template=bankapp-template`date +"%H%d%m%Y"` --region=us-central1;
gcloud compute instance-groups managed update bankapp-instance-group --project=XXXX-XXXXXXX-2XXXX6 --health-check autohealing-health-check --initial-delay 300 --instance-redistribution-type="PROACTIVE" --region=us-central1